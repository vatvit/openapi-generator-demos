<?php
/**
 * PetStoreApiController
 * 
 * A sample API that uses a petstore as an example to demonstrate features in the OpenAPI 3.0 specification
 * 
 * PHP version 
 *
 * @category Class
 * @package  PetStoreApiV2\Server\Security
 * @author   OpenAPI Generator
 * @link     https://openapi-generator.tech
 */

/**
 * NOTE: This class is auto-generated by OpenAPI Generator
 * https://openapi-generator.tech
 * Do not edit this class manually.
 */

namespace PetStoreApiV2\Server\Security;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Auth\Access\AuthorizationException;

/**
 * SecurityValidator
 *
 * Runtime security validation middleware
 * Validates requests against OpenAPI security requirements
 *
 * @category Middleware
 * @package  PetStoreApiV2\Server\Security
 * @author   OpenAPI Generator
 * @link     https://openapi-generator.tech
 */
class SecurityValidator
{
    /**
     * Security implementation
     *
     * @var SecurityInterface
     */
    protected SecurityInterface $security;

    /**
     * Constructor
     *
     * @param SecurityInterface $security Security implementation
     */
    public function __construct(SecurityInterface $security)
    {
        $this->security = $security;
    }

    /**
     * Validate any security requirement (OR logic)
     *
     * At least one security scheme must pass
     *
     * @param Request $request
     * @param Closure $next
     * @param string $schemes Comma-separated security scheme names
     * @return mixed
     * @throws AuthenticationException
     */
    public function validateAny(Request $request, Closure $next, string $schemes)
    {
        $schemeList = array_map('trim', explode(',', $schemes));
        $errors = [];

        foreach ($schemeList as $scheme) {
            try {
                $methodName = 'authenticate' . $scheme;
                if (method_exists($this->security, $methodName)) {
                    $authenticated = $this->security->$methodName($request);
                    if ($authenticated) {
                        return $next($request);
                    }
                }
            } catch (\Exception $e) {
                $errors[] = "{$scheme}: {$e->getMessage()}";
            }
        }

        throw new AuthenticationException(
            'Authentication failed. None of the security schemes passed: ' . implode(', ', $errors)
        );
    }

    /**
     * Validate all security requirements (AND logic)
     *
     * All security schemes must pass
     *
     * @param Request $request
     * @param Closure $next
     * @param string $schemes Comma-separated security scheme names
     * @return mixed
     * @throws AuthenticationException
     */
    public function validateAll(Request $request, Closure $next, string $schemes)
    {
        $schemeList = array_map('trim', explode(',', $schemes));

        foreach ($schemeList as $scheme) {
            $methodName = 'authenticate' . $scheme;
            if (method_exists($this->security, $methodName)) {
                $authenticated = $this->security->$methodName($request);
                if (!$authenticated) {
                    throw new AuthenticationException("Authentication failed for scheme: {$scheme}");
                }
            } else {
                throw new AuthenticationException("Unknown security scheme: {$scheme}");
            }
        }

        return $next($request);
    }
}
