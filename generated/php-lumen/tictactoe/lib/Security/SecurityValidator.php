<?php
/**
 * Tic Tac Toe
 * 
 * This API allows writing down marks on a Tic Tac Toe board and requesting the state of the board or of individual squares.
 * 
 * PHP version 
 *
 * @category Class
 * @package  TicTacToeApiV2\Server\Security
 * @author   OpenAPI Generator
 * @link     https://openapi-generator.tech
 */

/**
 * NOTE: This class is auto-generated by OpenAPI Generator
 * https://openapi-generator.tech
 * Do not edit this class manually.
 */

namespace TicTacToeApiV2\Server\Security;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Auth\Access\AuthorizationException;

/**
 * SecurityValidator
 *
 * Runtime security validation middleware
 * Validates requests against OpenAPI security requirements
 *
 * @category Middleware
 * @package  TicTacToeApiV2\Server\Security
 * @author   OpenAPI Generator
 * @link     https://openapi-generator.tech
 */
class SecurityValidator
{
    /**
     * Security implementation
     *
     * @var SecurityInterface
     */
    protected SecurityInterface $security;

    /**
     * Constructor
     *
     * @param SecurityInterface $security Security implementation
     */
    public function __construct(SecurityInterface $security)
    {
        $this->security = $security;
    }

    /**
     * Validate defaultApiKey authentication
     *
     * @param Request $request
     * @param Closure $next
     * @param array<string> $scopes Required scopes
     * @return mixed
     * @throws AuthenticationException
     * @throws AuthorizationException
     */
    public function validatedefaultApiKey(Request $request, Closure $next, ...$scopes)
    {
        // Authenticate using defaultApiKey scheme
        $authenticated = $this->security->authenticatedefaultApiKey($request);

        if (!$authenticated) {
            throw new AuthenticationException('Authentication failed for defaultApiKey');
        }

        // Authorize with required scopes
        if (!empty($scopes)) {
            $authorized = $this->security->authorize($request, $scopes);

            if (!$authorized) {
                throw new AuthorizationException('Insufficient permissions');
            }
        }

        return $next($request);
    }

    /**
     * Validate basicHttpAuthentication authentication
     *
     * @param Request $request
     * @param Closure $next
     * @param array<string> $scopes Required scopes
     * @return mixed
     * @throws AuthenticationException
     * @throws AuthorizationException
     */
    public function validatebasicHttpAuthentication(Request $request, Closure $next, ...$scopes)
    {
        // Authenticate using basicHttpAuthentication scheme
        $authenticated = $this->security->authenticatebasicHttpAuthentication($request);

        if (!$authenticated) {
            throw new AuthenticationException('Authentication failed for basicHttpAuthentication');
        }

        // Authorize with required scopes
        if (!empty($scopes)) {
            $authorized = $this->security->authorize($request, $scopes);

            if (!$authorized) {
                throw new AuthorizationException('Insufficient permissions');
            }
        }

        return $next($request);
    }

    /**
     * Validate bearerHttpAuthentication authentication
     *
     * @param Request $request
     * @param Closure $next
     * @param array<string> $scopes Required scopes
     * @return mixed
     * @throws AuthenticationException
     * @throws AuthorizationException
     */
    public function validatebearerHttpAuthentication(Request $request, Closure $next, ...$scopes)
    {
        // Authenticate using bearerHttpAuthentication scheme
        $authenticated = $this->security->authenticatebearerHttpAuthentication($request);

        if (!$authenticated) {
            throw new AuthenticationException('Authentication failed for bearerHttpAuthentication');
        }

        // Authorize with required scopes
        if (!empty($scopes)) {
            $authorized = $this->security->authorize($request, $scopes);

            if (!$authorized) {
                throw new AuthorizationException('Insufficient permissions');
            }
        }

        return $next($request);
    }

    /**
     * Validate app2AppOauth authentication
     *
     * @param Request $request
     * @param Closure $next
     * @param array<string> $scopes Required scopes
     * @return mixed
     * @throws AuthenticationException
     * @throws AuthorizationException
     */
    public function validateapp2AppOauth(Request $request, Closure $next, ...$scopes)
    {
        // Authenticate using app2AppOauth scheme
        $authenticated = $this->security->authenticateapp2AppOauth($request);

        if (!$authenticated) {
            throw new AuthenticationException('Authentication failed for app2AppOauth');
        }

        // Authorize with required scopes
        if (!empty($scopes)) {
            $authorized = $this->security->authorize($request, $scopes);

            if (!$authorized) {
                throw new AuthorizationException('Insufficient permissions');
            }
        }

        return $next($request);
    }

    /**
     * Validate user2AppOauth authentication
     *
     * @param Request $request
     * @param Closure $next
     * @param array<string> $scopes Required scopes
     * @return mixed
     * @throws AuthenticationException
     * @throws AuthorizationException
     */
    public function validateuser2AppOauth(Request $request, Closure $next, ...$scopes)
    {
        // Authenticate using user2AppOauth scheme
        $authenticated = $this->security->authenticateuser2AppOauth($request);

        if (!$authenticated) {
            throw new AuthenticationException('Authentication failed for user2AppOauth');
        }

        // Authorize with required scopes
        if (!empty($scopes)) {
            $authorized = $this->security->authorize($request, $scopes);

            if (!$authorized) {
                throw new AuthorizationException('Insufficient permissions');
            }
        }

        return $next($request);
    }

    /**
     * Validate any security requirement (OR logic)
     *
     * At least one security scheme must pass
     *
     * @param Request $request
     * @param Closure $next
     * @param string $schemes Comma-separated security scheme names
     * @return mixed
     * @throws AuthenticationException
     */
    public function validateAny(Request $request, Closure $next, string $schemes)
    {
        $schemeList = array_map('trim', explode(',', $schemes));
        $errors = [];

        foreach ($schemeList as $scheme) {
            try {
                $methodName = 'authenticate' . $scheme;
                if (method_exists($this->security, $methodName)) {
                    $authenticated = $this->security->$methodName($request);
                    if ($authenticated) {
                        return $next($request);
                    }
                }
            } catch (\Exception $e) {
                $errors[] = "{$scheme}: {$e->getMessage()}";
            }
        }

        throw new AuthenticationException(
            'Authentication failed. None of the security schemes passed: ' . implode(', ', $errors)
        );
    }

    /**
     * Validate all security requirements (AND logic)
     *
     * All security schemes must pass
     *
     * @param Request $request
     * @param Closure $next
     * @param string $schemes Comma-separated security scheme names
     * @return mixed
     * @throws AuthenticationException
     */
    public function validateAll(Request $request, Closure $next, string $schemes)
    {
        $schemeList = array_map('trim', explode(',', $schemes));

        foreach ($schemeList as $scheme) {
            $methodName = 'authenticate' . $scheme;
            if (method_exists($this->security, $methodName)) {
                $authenticated = $this->security->$methodName($request);
                if (!$authenticated) {
                    throw new AuthenticationException("Authentication failed for scheme: {$scheme}");
                }
            } else {
                throw new AuthenticationException("Unknown security scheme: {$scheme}");
            }
        }

        return $next($request);
    }
}
